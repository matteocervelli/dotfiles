# Makefile per la gestione dell'ambiente di sviluppo

.PHONY: check-env generate-env setup-dev start-dev start-mcp stop-mcp create-networks verify-env setup-env start-all stop-all status scale backup health-check update new-project

# Verifica permessi di esecuzione degli script
check-env:
	@echo "ğŸ” Verifica configurazione ambiente..."
	@./scripts/verify-env.sh

# Genera i file .env per ogni servizio
generate-env:
	@echo "ğŸ”§ Generazione file .env..."
	@./scripts/generate-env.sh

# Setup ambiente di sviluppo
setup-dev: check-env generate-env
	@echo "ğŸš€ Setup ambiente di sviluppo..."
	@./scripts/setup.sh
	@echo "âœ… Ambiente configurato correttamente!"

# Avvia i servizi di sviluppo
start-dev: setup-dev
	@echo "ğŸš€ Avvio servizi di sviluppo..."
	@docker-compose -f compose/infrastructure.yml up -d postgres
	@echo "â³ Attesa avvio PostgreSQL..."
	@sleep 10
	@docker-compose -f compose/infrastructure.yml up -d redis qdrant minio
	@echo "â³ Attesa avvio servizi di base..."
	@sleep 10
	@docker-compose -f compose/infrastructure.yml up -d n8n
	@echo "â³ Attesa avvio N8N..."
	@sleep 10
	@docker-compose -f compose/infrastructure.yml up -d nginx
	@echo "âœ… Servizi di sviluppo avviati correttamente!"

# Avvia i servizi MCP
start-mcp: setup-dev
	@echo "ğŸš€ Avvio servizi MCP..."
	@docker-compose -f compose/mcp.yml up -d
	@echo "âœ… Servizi MCP avviati correttamente!"

# Ferma i servizi MCP
stop-mcp:
	@echo "ğŸ›‘ Arresto servizi MCP..."
	@docker-compose -f compose/mcp.yml down
	@echo "âœ… Servizi MCP arrestati correttamente!"

# Crea le reti Docker necessarie
create-networks:
	@echo "ğŸŒ Creazione reti Docker..."
	@./scripts/setup-networks.sh

# Verifica ambiente
verify-env:
	@echo "ğŸ” Verifica configurazione ambiente..."
	@./scripts/verify-env.sh

# Setup ambiente
setup-env: verify-env generate-env
	@echo "ğŸš€ Setup ambiente di sviluppo..."
	@./scripts/setup.sh
	@echo "âœ… Ambiente configurato correttamente!"

# Avvia tutti i servizi
start-all: setup-env create-networks
	@echo "ğŸš€ Avvio tutti i servizi..."
	@docker-compose -f compose/monitoring.yml up -d
	@docker-compose -f compose/infrastructure.yml up -d
	@docker-compose -f compose/mcp.yml up -d
	@echo "âœ… Tutti i servizi avviati correttamente!"

# Ferma tutti i servizi
stop-all:
	@echo "ğŸ›‘ Arresto servizi..."
	@docker-compose -f compose/monitoring.yml down
	@docker-compose -f compose/mcp.yml down
	@docker-compose -f compose/infrastructure.yml down
	@echo "âœ… Servizi arrestati correttamente!"

# Mostra lo stato dei servizi
status:
	@echo "ğŸ“Š Stato dei servizi:"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# Scala un servizio
scale:
	@echo "ğŸ”„ Scaling del servizio..."
	@./scripts/scale.sh $(service) $(replicas)

# Backup dei dati
backup:
	@echo "ğŸ’¾ Backup dei dati..."
	@./scripts/backup.sh

# Verifica salute dei servizi
health-check:
	@echo "ğŸ¥ Verifica salute dei servizi..."
	@./scripts/health-check.sh

# Aggiorna i servizi
update:
	@echo "â¬†ï¸ Aggiornamento dei servizi..."
	@./scripts/update.sh

# Crea un nuovo progetto basato sulla struttura _base
new-project:
	@echo "ğŸš€ Creazione nuovo progetto..."
	@if [ -z "$(name)" ] || [ -z "$(desc)" ]; then \
		echo "âŒ Errore: Specificare name e desc"; \
		echo "ğŸ“‹ Usage: make new-project name=\"APP-MyProject\" desc=\"Descrizione del progetto\""; \
		echo "ğŸ“‹ Esempi:"; \
		echo "   make new-project name=\"APP-TaskManager\" desc=\"Applicazione per gestire task e progetti\""; \
		echo "   make new-project name=\"WEB-Portfolio\" desc=\"Sito web portfolio personale\""; \
		echo "   make new-project name=\"FE-Dashboard\" desc=\"Dashboard frontend per analytics\""; \
		exit 1; \
	fi
	@./scripts/launch-projects.sh "$(name)" "$(desc)"
	@echo "âœ… Progetto $(name) creato con successo!"
	@echo "ğŸ“ Prossimi passi:"
	@echo "   1. cd projects/$(name)"
	@echo "   2. Apri cursor-project-setup.md per le istruzioni" 