# PostgreSQL Configuration
# Optimized for production use on VPS (2-4GB RAM)

# ============================================================================
# Connection Settings
# ============================================================================
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# ============================================================================
# Memory Settings
# ============================================================================
# For 2GB RAM VPS:
shared_buffers = 512MB              # 25% of RAM
effective_cache_size = 1536MB       # 75% of RAM
maintenance_work_mem = 128MB
work_mem = 5MB                      # RAM / max_connections
wal_buffers = 16MB

# For 4GB RAM VPS, adjust:
# shared_buffers = 1GB
# effective_cache_size = 3GB
# maintenance_work_mem = 256MB
# work_mem = 10MB

# ============================================================================
# Write Ahead Log (WAL)
# ============================================================================
wal_level = replica
wal_compression = on
max_wal_size = 1GB
min_wal_size = 80MB
wal_keep_size = 512MB

# ============================================================================
# Checkpoints
# ============================================================================
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# ============================================================================
# Query Planner
# ============================================================================
random_page_cost = 1.1              # For SSD storage
effective_io_concurrency = 200      # For SSD storage
default_statistics_target = 100

# ============================================================================
# Parallel Query Execution
# ============================================================================
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# ============================================================================
# Logging
# ============================================================================
logging_collector = on
log_destination = 'stderr'
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# Log statement types
log_statement = 'mod'               # none, ddl, mod, all
log_duration = on
log_min_duration_statement = 1000   # Log slow queries (>1s)

# Connection logging
log_connections = on
log_disconnections = on
log_hostname = off

# Lock logging
log_lock_waits = on                 # Log long lock waits
deadlock_timeout = 1s

# ============================================================================
# Query and Index Statistics
# ============================================================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# ============================================================================
# Autovacuum
# ============================================================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# ============================================================================
# Client Connection Defaults
# ============================================================================
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# ============================================================================
# Lock Management
# ============================================================================
deadlock_timeout = 1s
max_locks_per_transaction = 64

# ============================================================================
# Extensions and Contrib
# ============================================================================
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on
