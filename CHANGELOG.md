# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added

- **Application Management System** (FASE 3.1, Issue #19)
  - `scripts/apps/audit-apps.sh` - Comprehensive application discovery and listing (~450 lines)
  - `scripts/apps/cleanup-apps.sh` - Safe application removal with dry-run mode (~250 lines)
  - `applications/` directory structure with README and templates
  - `applications/README.md` - Complete workflow guide with examples and troubleshooting
  - `applications/keep-apps.txt` - Template for apps to preserve
  - `applications/remove-apps.txt` - Template for apps to remove
  - `tests/test-19-app-audit.bats` - Comprehensive BATS test suite (38 tests, 33/34 passing)
  - `docs/TECH-STACK.md` - Complete technology stack documentation
  - Application discovery from five sources:
    - Homebrew casks (GUI apps) via `brew list --cask`
    - Homebrew formulae (CLI tools) via `brew list --formula`
    - Mac App Store apps via `mas list`
    - Setapp apps from `/Applications/Setapp/`
    - Manual installations from `/Applications/*.app`
  - Timestamped audit reports: `current_macos_apps_YYYY-MM-DD.txt`
  - Smart removal detection (Homebrew vs manual)
  - Safety features:
    - Default dry-run mode (no deletions without explicit `--execute` flag)
    - User confirmation prompts before any removal
    - Input validation (comments and blank lines ignored)
    - Whitespace trimming for app names
    - Detailed logging to `applications/cleanup.log`
    - Path sanitization and validation
  - Workflow: Audit → Review → Categorize → Test (dry-run) → Execute
  - Categorized output with counts per source (5 sections)
  - Statistics reporting (removed/failed/skipped apps)
  - Integration with Brewfile management
  - Performance: < 10 seconds for audit, < 5 seconds for cleanup dry-run
  - Complete documentation in README.md, CLAUDE.md, and applications/README.md
  - **Bug fix**: Resolved critical `set -e` + conditional logging issue that caused silent failures
    - Added `|| true` to all conditional log statements to ensure proper exit codes

- **Auto-Update Dotfiles Mechanism** (FASE 2.6, Issue #18)
  - `scripts/sync/auto-update-dotfiles.sh` - Automatically sync dotfiles with pull-before-push strategy (100 lines)
  - `scripts/sync/install-autoupdate.sh` - Platform-specific installer for auto-update service (65 lines)
  - `system/macos/launch-agents/com.dotfiles.autoupdate.plist` - macOS LaunchAgent configuration (30 min interval)
  - `system/ubuntu/systemd/dotfiles-autoupdate.service` - Ubuntu systemd service configuration
  - `system/ubuntu/systemd/dotfiles-autoupdate.timer` - Ubuntu systemd timer (30 min interval, persistent)
  - `tests/test-18-auto-update-dotfiles.bats` - Comprehensive test suite (13 tests, all passing)
  - **Pull-Before-Push Strategy**: Automatically syncs changes across machines every 30 minutes
  - Smart sync workflow:
    1. Fetch remote changes first
    2. If remote has updates: stash local changes → pull with rebase → pop stash
    3. If no conflicts: commit local changes → push to GitHub
    4. If conflicts: log error and stop (manual intervention required)
  - Security features:
    - Only operates on main branch (skips feature branches to avoid conflicts)
    - Uses existing git credentials (SSH keys or 1Password integration)
    - Early exit when no changes detected (performance optimization)
    - User-level permissions (no sudo required for operation)
    - Safe stashing prevents data loss during pull operations
  - Conflict handling:
    - Automatic resolution for non-overlapping changes (different files)
    - Stops and logs error for real conflicts (same file, same lines)
    - Preserves local changes in git stash for manual resolution
    - Clear error messages with recovery instructions
  - Platform support:
    - macOS: LaunchAgent with launchctl integration, logs to `/tmp/dotfiles-autoupdate.log`
    - Ubuntu: systemd service + timer with journalctl logging
    - Auto-detection via existing `detect-os.sh` utility
  - Offline-safe: Gracefully handles network failures, retries next cycle
  - Commit message format: `chore: auto-update dotfiles from <hostname> - <timestamp>`
  - Easy installation: `./scripts/sync/install-autoupdate.sh`
  - Easy disable: `launchctl unload` (macOS) or `systemctl stop` (Ubuntu)
  - Logs available for debugging: stdout and stderr separated on macOS, journalctl on Ubuntu
  - Integration with existing dotfiles infrastructure (logger.sh, detect-os.sh)
- **Asset Management System Documentation** (FASE 2.X, Issue #34)
  - `sync/library/README.md` - Comprehensive central library guide with workflows, best practices, and troubleshooting
  - `templates/README.md` - Complete asset helpers documentation for TypeScript and Python
  - Updated `sync/manifests/README.md` - Added central library workflow, environment switching guide, and auto-update sections
  - Updated `sync/manifests/schema.yml` - Expanded field documentation with detailed use cases and examples
  - Updated `README.md` - Added comprehensive asset management system section with quick start and examples
  - Complete documentation for all asset management features (Issues #29-#32)
  - All workflows documented: library updates, project sync, auto-propagation, environment switching
  - Migration guides for existing projects
  - Security and performance best practices
  - Troubleshooting sections with common issues and solutions
  - Command reference tables with links to detailed documentation

- **Environment-Aware Asset Helpers** (FASE 2.X, Issue #32)
  - `templates/project/lib/assets.ts` - TypeScript/JavaScript asset URL resolver (370 lines)
  - `templates/project/lib/assets.py` - Python asset URL resolver (380 lines)
  - `templates/project/lib/__tests__/assets.test.ts` - Example Jest/Vitest tests (280 lines)
  - `templates/project/lib/tests/test_assets.py` - Example pytest tests (440 lines)
  - `tests/test-32-environment-helpers.bats` - BATS validation tests (57 tests)
  - Environment-aware URL resolution: local paths in dev, CDN URLs in production
  - Zero external dependencies for maximum compatibility
  - Support for three env modes: `cdn-production-local-dev` (default), `cdn-always`, `local-always`
  - TypeScript features:
    - AssetResolver singleton class with cached environment detection
    - getAssetUrl() convenience function
    - useAsset() React hook with useMemo optimization
    - batchResolveAssets() for multiple assets
    - Full TypeScript types and comprehensive JSDoc
  - Python features:
    - AssetResolver singleton class with @lru_cache performance optimization
    - get_asset_url() convenience function
    - batch_resolve_assets() for multiple assets
    - Complete type hints with typing module
    - Comprehensive docstrings with examples
  - Security features:
    - Path traversal prevention (rejects '..' in paths)
    - URL validation (HTTPS required in production)
    - Input sanitization for all parameters
  - Performance optimizations:
    - Environment detection cached (TypeScript: singleton pattern, Python: @lru_cache)
    - React hook memoization prevents unnecessary re-renders
    - Zero network calls (pure URL resolution)
  - Framework compatibility:
    - TypeScript: Next.js, Vite, React, any Node.js/browser environment
    - Python: FastAPI, Flask, Django, standalone applications
  - Auto-detects environment from NODE_ENV (TypeScript) or ENVIRONMENT (Python)
  - Manual override via ASSET_MODE environment variable (local, cdn, auto)
  - Comprehensive test suites included as templates for projects
  - All files under 500 lines, modular design
  - Ready-to-copy templates for project integration
- **Auto-Update Propagation Across Projects** (FASE 2.X, Issue #31)
  - `scripts/sync/update-cdn-and-notify.sh` - Orchestrate CDN update workflow with notifications and propagation (280 lines)
  - `scripts/sync/propagate-cdn-updates.sh` - Propagate library changes to all affected projects (570 lines)
  - `stow-packages/bin/.local/bin/update-cdn` - Convenience wrapper for update workflow
  - Interactive workflow with user confirmation prompts
  - Before/after comparison showing dimension and size changes
  - Project detection via source field and filename matching
  - Automatic manifest updates (checksum, size, dimensions)
  - Re-copy files from library to projects with verification
  - Optional git commits (off by default, `--git-commit` flag)
  - Optional R2 sync integration
  - Statistics reporting: projects scanned/updated/skipped, files copied
  - Colored terminal output: green (updates), gray (skips), red (errors)
  - Non-interactive modes: `--auto-propagate`, `--auto-sync`, `--no-propagate`, `--no-sync`
  - Performance: <5 minutes for 10+ projects (vs ~30 min manual)
  - Comprehensive test suite (`tests/test-31-auto-update.bats`) with 24 tests
  - Architecture decision record (`docs/architecture/ADR/ADR-003-auto-update-propagation.md`)
  - Integration with Issues #29 and #30 (notification and project sync systems)
  - Bash 3.2 compatible (macOS default shell)
  - Documentation updates in `sync/manifests/README.md` and `README.md`
- **Project Asset Sync with Library-First Strategy** (FASE 2.X, Issue #30)
  - `scripts/sync/generate-project-manifest.sh` - Generate project-specific manifests with library detection (570 lines)
  - `scripts/sync/sync-project-assets.sh` - Sync assets with library-first copy strategy and R2 fallback (680 lines)
  - `stow-packages/bin/.local/bin/sync-project` - Convenience wrapper for quick asset syncing
  - Library-first strategy: Try copy from `~/media/cdn/` (fast, <0.1s/file) → Fallback to R2 download (slower, 1-5s/file)
  - Smart sync modes in manifest:
    - `copy-from-library` - Copy from central library with R2 fallback
    - `download` - Download directly from R2
    - `cdn-only` - Verify CDN URL, skip local sync
    - `false` - Manual download required (shows instructions)
  - Device filtering: Skip assets not intended for current device (via `devices: [list]` in manifest)
  - Automatic library detection: Checks if project files exist in `~/media/cdn/` by filename matching
  - SHA256 checksum verification on all copy/download operations (prevents corruption)
  - Statistics reporting: Shows copied vs downloaded counts, library efficiency percentage
  - Colored terminal output: Green for library copies, blue for downloads, gray for skips
  - Project directory scanning: `public/media/`, `data/`, `public/images/`, `assets/`
  - Smart sync defaults: Files >100MB marked as manual download (`sync: false`)
  - Comprehensive test suite (`tests/test-30-project-sync.bats`) with 42 tests (41 passing, 97.6% pass rate)
  - Architecture decision record (`docs/architecture/ADR/ADR-002-project-asset-sync.md`)
  - Performance achieved: 90% library efficiency (45 copied, 5 downloaded typical project)
  - Integration with Issue #29 manifest system (reuses central library `.r2-manifest.yml`)
  - Bash 3.2 compatible (macOS default shell)

- **Enhanced R2 Manifest System with Dimension Extraction** (FASE 2.X, Issue #29)
  - `scripts/sync/generate-cdn-manifest.sh` - Automatic manifest generation with image dimension extraction using ImageMagick
  - `scripts/sync/notify-cdn-updates.sh` - Update notification system with before/after comparison and colored output
  - Enhanced `sync/manifests/schema.yml` with new fields:
    - `dimensions: {width, height}` - Automatic image dimension extraction
    - `env_mode` - Environment-aware asset resolution (cdn-production-local-dev, cdn-always, local-always)
    - Enhanced `sync` field - Smart sync strategies (copy-from-library, download, cdn-only)
  - Example 6 added to schema: Environment-aware assets with dimensions
  - Dimension caching system (`.dimensions-cache.json`) for 10x performance improvement
  - Content-based file type detection using `file` command (not extension-based)
  - Bash 3.2 compatibility for macOS (uses grep instead of associative arrays)
  - Colored terminal output with ANSI colors (green/red/yellow for changes)
  - Markdown report generation for commit messages
  - Comprehensive test suite (`tests/test-29-manifest-system.bats`) with 30 tests
  - Architecture decision record (`docs/architecture/ADR/ADR-001-manifest-dimension-extraction.md`)
  - Performance target achieved: 100 files in <10 seconds

- **R2 Manifest System** (`sync/manifests/`) - FASE 2.4 (Issue #16)
  - `sync/manifests/schema.yml` - Complete YAML schema definition with field types and examples
  - `sync/manifests/README.md` - Comprehensive documentation covering workflow, best practices, and troubleshooting
  - Schema defines structure for `.r2-manifest.yml` files in project roots
  - Manifest tracks binary assets: path, R2 key, size, SHA256 checksum, type, sync settings, device targeting
  - Asset types supported: model, dataset, media, video, audio, document, data
  - Selective sync with `sync: false` for manual-only downloads
  - Device targeting with `devices: [macbook, mac-studio]` for machine-specific assets
  - Integration with rclone, 1Password, and project dev-setup.sh scripts
  - Workflow documented: generate → push → pull → update → verify
  - Best practices: commit manifests to git, gitignore actual assets, selective sync, checksum verification
  - Troubleshooting guide for common issues (checksum mismatch, missing assets, large transfers)
  - Example manifests for AI/ML projects, datasets, media files, and empty projects
  - Scripts (to be implemented in FASE 2.5): generate-manifest.sh, sync-r2.sh, update-manifest.sh, verify-manifest.sh
- **Rclone Setup for R2** (`sync/rclone/`, `stow-packages/bin/`) - FASE 2.3 (Issue #15)
  - `sync/rclone/rclone.conf.template` - Configuration template with 1Password references
  - `sync/rclone/README.md` - Comprehensive documentation with setup, usage, and troubleshooting
  - `stow-packages/bin/.local/bin/setup-rclone` - Automated setup with 1Password secret injection (symlinkable)
  - `stow-packages/bin/.local/bin/test-rclone` - Connection testing and validation script (symlinkable)
  - `stow-packages/bin/.local/bin/rclone-cdn-sync` - Media CDN synchronization to R2 (migrated from ~/dev/scripts/)
  - Shell alias: `cdnsync` → `~/.local/bin/rclone-cdn-sync` (defined in shell package)
  - 1Password integration: Credentials stored in vault (Private/Cloudflare-R2)
  - Security: Config file permissions 600, gitignored, never committed
  - Remote configured: `remote-cdn:` for Cloudflare R2 bucket `media-adlimen`
  - Usage after stow: `setup-rclone` → `test-rclone` → `cdnsync`
  - Tested: ✅ Connection verified, 253 files in bucket
- **Project Setup Script Template** (`templates/project/`) - FASE 2.2 (Issue #14)
  - `dev-setup.sh.template` - Standard project initialization script for all projects
  - `README.md` - Comprehensive usage documentation with examples and troubleshooting
  - `.env.development.template` - Development environment template with 1Password references
  - `.env.production.template` - Production environment template with 1Password references
  - Automated workflow: Git clone/pull → Secret injection → Asset sync (R2) → Project-specific setup
  - Multi-level 1Password tagging system: [PROJECT] + [ENVIRONMENT] + [TYPE] + [CUSTOM]
  - Support for shared secrets across multiple projects via tags
  - Environment-aware configuration (development, staging, production)
  - Vault override support: `export OP_VAULT=Projects` for centralized vault strategy
  - `scripts/secrets/create-project-secret.sh` - CLI tool for creating 1Password secrets with proper categories
  - Supports proper 1Password item types: Database, API Credential, Login, Server (native fields)
  - Tag hierarchy enables flexible querying: by project, environment, type, or combinations
  - Example: `op item list --vault=Projects --tags=APP-Discreto,production,database`
- **Production Secret Management** (`templates/production/`) - FASE 2.2 (Issue #14)
  - `setup-prod-secrets.sh` - VPS setup script for Docker Secrets initialization
  - `.env.prod.template` - Production environment template (for VPS without 1Password)
  - Docker Secrets integration: encrypted at rest, mounted as files in `/run/secrets/`
  - One-time secret injection from 1Password to Docker Secrets on VPS
  - Security: Secrets stored encrypted, accessed via file mounts (not environment variables)
  - Integration with docker-compose for production deployments
- **1Password CLI Integration** (`scripts/secrets/`, `secrets/`) - FASE 2.1 (Issue #13)
  - `inject-env.sh` - Wrapper for `op inject` with authentication checking and validation
  - `validate-secrets.sh` - Verify secret injection completeness (detects remaining op:// references)
  - `template.env` - Standard .env template with 1Password reference examples
  - `docker-compose-op.yml` - Docker Compose example with 1Password integration
  - Automated secret injection from 1Password to .env files
  - Security: No secrets ever committed to git (gitignore configured)
  - Usage: `./scripts/secrets/inject-env.sh .env.template` (auto-generates .env)
  - Validation: `./scripts/secrets/validate-secrets.sh .env` (checks for uninjected refs)
  - Intended workflow: Each project has `dev-setup.sh` script that calls inject-env.sh
  - Cross-platform support (macOS, Linux)
- **Makefile orchestration** (`Makefile`) - FASE 1.9
  - Unified command interface for dotfiles management
  - `make help` - Display all available commands with examples
  - `make install` - Full installation (bootstrap + stow + health)
  - `make bootstrap` - Install dependencies only
  - `make stow` / `make stow-all` - Stow all packages (create symlinks)
  - `make stow-dry-run` / `make stow-all-dry-run` - Preview all packages before stowing (dry-run mode)
  - `make unstow` - Remove all symlinks
  - `make stow-package PKG=<name>` - Stow single package
  - `make stow-package-dry-run PKG=<name>` - Preview single package before stowing (dry-run mode)
  - `make health` - Run comprehensive health checks
  - `make backup` - Backup current configurations (placeholder, full implementation in FASE 2)
  - `make clean` - Clean temporary files (.DS_Store, *.tmp, *.log)
  - Formatted help menu with usage examples and emoji indicators
  - Integration with all existing scripts in `scripts/` directory
  - All stow operations support dry-run mode for safe preview before applying changes
- Health check scripts (`scripts/health/`) - FASE 1.8
  - `check-stow.sh` - Verify GNU Stow symlinks point to correct dotfiles locations
  - `check-all.sh` - Comprehensive health check (OS, dependencies, 1Password auth, symlinks, Git config)
  - Support for verbose mode (`-v`) to show all checks including successful ones
  - Proper exit codes: 0 (success), 1 (failures detected)
  - Smart symlink verification with relative path resolution (GNU Stow compatibility)
  - Actionable error messages with suggested fixes
  - Statistics summary: total checks, passed, warnings, failed
- Stow automation scripts (`scripts/stow/`) - FASE 1.7
  - `stow-all.sh` - Batch installer for all stow packages with statistics
  - `stow-package.sh` - Individual package manager with --no-folding support
  - `unstow-all.sh` - Batch uninstaller with safety confirmation and dry-run
  - Comprehensive error handling and user feedback
  - Dry-run mode support across all scripts
  - Verbose and quiet output modes
- SSH configuration package (`stow-packages/ssh/`) - FASE 1.6
  - Modular SSH configuration with `config.d/` directory structure
  - Cross-platform support (macOS and Linux) with platform-specific 1Password agent paths
  - Complete Tailscale network configuration for all devices (studio, macbook, nas, sara's devices)
  - GitHub SSH configuration with 1Password authentication
  - VPS servers configuration (`30-vps.conf`) - tracked in git
  - Work/client servers template (`40-work.conf.template`) - gitignored
  - Connection multiplexing with ControlMaster for faster SSH
  - Include directive for modular config file loading
  - Comprehensive README with usage examples and troubleshooting
- Git configuration package (`stow-packages/git/`) - FASE 1.6
  - Complete `.gitconfig` with 1Password SSH signing integration
  - Comprehensive Git aliases (30+ shortcuts for common operations)
  - Minimal `.gitignore_global` with gitignore.io-first philosophy
  - Git hooks template directory (`.git-templates/hooks/`)
  - SSH allowed signers file for commit verification
  - Machine-specific override template (`.gitconfig.local.template`)
  - Cross-platform support (macOS, Linux, Windows via WSL)
  - Comprehensive documentation and troubleshooting guide
- Bootstrap scripts for automated dependency installation (FASE 1.5)
  - macOS bootstrap with Homebrew-based installation
  - Ubuntu bootstrap with apt/wget-based installation
  - Master install orchestrator with automatic OS detection
  - Idempotent operations: safe to run multiple times
  - Dependencies installed: GNU Stow, 1Password CLI, Rclone, yq
- OS detection utility (`scripts/utils/detect-os.sh`)
- Logging utilities with colored output (`scripts/utils/logger.sh`)

### Changed

- **Project Organization**: Reorganized LLM tools package for better sprint alignment
  - Separated 1Password package (Issue #9) from LLM tools configuration
  - Moved llm-tools package from FASE 1.6 to FASE 3.5 (Issue #28)
  - Rationale: FASE 1 focuses on essential foundations, FASE 3 on application configurations
  - 1Password remains in FASE 1 (required for secret management in subsequent phases)
  - LLM tools (Claude Code, MCP servers) now grouped with other dev applications
- Shell package (`stow-packages/shell/`) - Removed Tailscale SSH aliases
  - Removed `alias macbook` and `alias macstudio` from `aliases.sh`
  - Replaced with professional SSH config approach (better cross-tool compatibility)
  - Added comment referencing new SSH config location

## [0.1.0] - 2025-01-17

### Added

- Initial project structure
- Documentation framework
- GNU Stow-based dotfiles management architecture
